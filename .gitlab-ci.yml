image: docker:stable

include:
  - project: divio/infra/gitlab-pipelines
    ref: master
    file: base/.gitlab-ci.yml

variables:
  DOCKER_HOST: tcp://docker:2376/
  #DOCKER_DRIVER: overlay2
  DOCKER_TLS_VERIFY: 1
  #DOCKER_TLS_CERTDIR: /certs
  DOCKER_CERT_PATH: /certs/client
  BUILDX_VERSION: v0.10.4
  BUILDX_ARCH: linux-amd64
  PLATFORMS: linux/arm/v7,linux/arm64/v8,linux/amd64
  PUBLIC_REPOSITORY: divio/base
  BUILDX_URL: https://github.com/docker/buildx/releases/download/${BUILDX_VERSION}/buildx-${BUILDX_VERSION}.${BUILDX_ARCH}

linting:
  image: divio/lint
  stage: qa
  needs: []
  allow_failure: true
  script:
    - find .
      -type f
      -name Dockerfile
      -not -path './EOL-*'
      -print0 | xargs -0 -I %
      sh -c 'LINT_FILE_DOCKER=% /bin/lint --check --run=docker'

build-dev:
  stage: build
  needs: []
  variables:
    TARGET: dev
    IMAGE_NAME: ${CI_REGISTRY_IMAGE}:${CI_COMMIT_TAG}-dev
  before_script:
    - wget -O /usr/bin/docker-buildx ${BUILDX_URL}
    - chmod +x /usr/bin/docker-buildx
    - ls -al /certs /certs/client
    - docker info
    - docker-buildx version
    - docker-buildx create --use
    - docker login -u ${CI_REGISTRY_USER} -p ${CI_JOB_TOKEN} ${CI_REGISTRY}
  script:
    - >
      docker-buildx build
      --platform ${PLATFORMS}
      --build-arg TARGET=${TARGET}
      --tag ${IMAGE_NAME}
      --push
      ${CI_COMMIT_TAG#*-}
  only:
    - tags
  #except:
  #  - branches

build-prod:
  stage: build
  needs: []
  variables:
    TARGET: prod
    IMAGE_NAME: ${CI_REGISTRY_IMAGE}:${CI_COMMIT_TAG}
  before_script:
    - wget -O /usr/bin/docker-buildx ${BUILDX_URL}
    - chmod +x /usr/bin/docker-buildx
    - docker-buildx version
    - docker-buildx create --use
    - docker info
    - docker login -u ${CI_REGISTRY_USER} -p ${CI_JOB_TOKEN} ${CI_REGISTRY}
  script:
    - >
      docker-buildx build
      --platform ${PLATFORMS}
      --build-arg TARGET=${TARGET}
      --tag ${IMAGE_NAME}
      --push
      ${CI_COMMIT_TAG#*-}
  only:
    - tags
  #except:
  #  - branches

test-dev:
  stage: test
  needs:
    - build-dev
  before_script:
    - docker login -u ${CI_REGISTRY_USER} -p ${CI_JOB_TOKEN} ${CI_REGISTRY}
  script:
    - >
      ./build.py
      --repo ${CI_REGISTRY_IMAGE}
      --target=dev
      --tag ${CI_COMMIT_TAG}
      test
  only:
    - tags
  #except:
  #  - branches

push:
  stage: release
  needs:
    - build-prod
    - test-dev
  image:
    name: ananace/skopeo
    entrypoint: [""]
  variables:
    GIT_STRATEGY: none
    IMAGE_NAME: ${CI_REGISTRY_IMAGE}:${CI_COMMIT_TAG}
    SRC_REGISTRY_CREDS: ${CI_REGISTRY_USER}:${CI_JOB_TOKEN}
  script:
    - >
      /skopeo
      copy
      --src-creds=${SRC_REGISTRY_CREDS}
      --dest-creds=${DST_REGISTRY_CREDS}
      docker://${CI_REGISTRY_IMAGE}:${CI_COMMIT_TAG}-dev
      docker://${PUBLIC_REPOSITORY}:${CI_COMMIT_TAG}-dev
    - >
      /skopeo
      copy
      --src-creds=${SRC_REGISTRY_CREDS}
      --dest-creds=${DST_REGISTRY_CREDS}
      docker://${CI_REGISTRY_IMAGE}:${CI_COMMIT_TAG}
      docker://${PUBLIC_REPOSITORY}:${CI_COMMIT_TAG}
  only:
    - tags
  #except:
  #  - branches
